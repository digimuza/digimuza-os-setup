services:
  lobechat:
    image: lobehub/lobehub:latest
    environment:
      - APP_URL=${APP_URL}
      - KEY_VAULTS_SECRET=${KEY_VAULTS_SECRET}
      - AUTH_SECRET=${AUTH_SECRET}
      - JWKS_KEY=${JWKS_KEY}
      - DATABASE_URL=postgresql://${LOBE_DB_USER}:${LOBE_DB_PASSWORD}@postgresql:5432/lobechat
      - PGUSER=${LOBE_DB_USER}
      - PGPASSWORD=${LOBE_DB_PASSWORD}
      - PGDATABASE=lobechat
      - PGHOST=postgresql
      - POSTGRES_USER=${LOBE_DB_USER}
      - POSTGRES_PASSWORD=${LOBE_DB_PASSWORD}
      - S3_ENDPOINT=${S3_ENDPOINT}
      - S3_PUBLIC_DOMAIN=${S3_PUBLIC_DOMAIN}
      - S3_BUCKET=lobechat
      - S3_ENABLE_PATH_STYLE=1
      - S3_ACCESS_KEY_ID=${S3_ACCESS_KEY_ID}
      - S3_SECRET_ACCESS_KEY=${S3_SECRET_ACCESS_KEY}
      - S3_SET_ACL=0
      - LLM_VISION_IMAGE_USE_BASE64=1
      - REDIS_URL=redis://redis:6379
      - REDIS_PREFIX=lobechat
      - REDIS_TLS=0
      - SEARXNG_URL=http://searxng:8080
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_PROXY_URL=${OPENAI_PROXY_URL}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - ANTHROPIC_PROXY_URL=${ANTHROPIC_PROXY_URL}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - GOOGLE_PROXY_URL=${GOOGLE_PROXY_URL}
    depends_on:
      postgresql:
        condition: service_healthy
      redis:
        condition: service_healthy
      bucket-init:
        condition: service_completed_successfully
    healthcheck:
      test: ['CMD-SHELL', 'curl -sf http://localhost:3210/ -o /dev/null || exit 1']
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 60s
    restart: always
    networks:
      - coolify

  postgresql:
    image: paradedb/paradedb:latest-pg17
    volumes:
      - lobechat-pg-data:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=lobechat
      - POSTGRES_USER=${LOBE_DB_USER}
      - POSTGRES_PASSWORD=${LOBE_DB_PASSWORD}
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${LOBE_DB_USER}']
      interval: 5s
      timeout: 5s
      retries: 5
    restart: always
    networks:
      - coolify

  redis:
    image: redis:7-alpine
    command: redis-server --save 60 1000 --appendonly yes
    volumes:
      - lobechat-redis-data:/data
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 5s
      timeout: 3s
      retries: 5
    restart: always
    networks:
      - coolify

  bucket-init:
    image: minio/mc:latest
    entrypoint: /bin/sh
    command: >
      -c '
      set -eux;
      mc alias set s3 "${S3_ENDPOINT}" "${S3_ACCESS_KEY_ID}" "${S3_SECRET_ACCESS_KEY}";
      mc mb "s3/lobechat" --ignore-existing;
      mc anonymous set download "s3/lobechat";
      '
    environment:
      - S3_ENDPOINT=${S3_ENDPOINT}
      - S3_ACCESS_KEY_ID=${S3_ACCESS_KEY_ID}
      - S3_SECRET_ACCESS_KEY=${S3_SECRET_ACCESS_KEY}
    restart: 'no'
    networks:
      - coolify

  searxng:
    image: searxng/searxng:latest
    volumes:
      - './searxng-settings.yml:/etc/searxng/settings.yml'
    environment:
      - SEARXNG_SETTINGS_FILE=/etc/searxng/settings.yml
    healthcheck:
      test: ['CMD-SHELL', 'wget --spider -q http://localhost:8080/ || exit 1']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    restart: always
    networks:
      - coolify

volumes:
  lobechat-pg-data: null
  lobechat-redis-data: null

networks:
  coolify:
    external: true
